<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>פרויקט מסדי נתונים - ספרייה</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="bg"></div>

  <header class="hero">
    <div class="hero__inner">
      <h1>פרויקט מסדי נתונים – ספרייה</h1>
      <p class="subtitle">
        נתונים נשאבים מה־MySQL דרך API (Node.js) ומתעדכנים לפי מה שקיים במסד הנתונים.
      </p>
      <div class="meta">
        <span class="pill">MySQL</span>
        <span class="pill">Node.js API</span>
        <span class="pill">GitHub Pages</span>
        <span class="pill">Render</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">

      <!-- BOOKS -->
      <section class="card" aria-label="Books Section">
        <div class="card__head">
          <h2 class="card__title">Books</h2>
          <div id="booksCounter" class="counter" style="display:none;"></div>
        </div>

        <div class="controls">
          <div class="actions">
            <button class="btn btn--primary" id="btnLoadBooks">רשימת ספרים</button>
          </div>

          <div class="field">
            <span>חיפוש</span>
            <input id="searchInput" type="text" placeholder="חיפוש לפי שם ספר / מזהה..." disabled />
          </div>

          <div class="field">
            <span>מיון</span>
            <select id="sortSelect" disabled>
              <option value="product_id_asc">מזהה עולה</option>
              <option value="product_id_desc">מזהה יורד</option>
              <option value="price_asc">מחיר עולה</option>
              <option value="price_desc">מחיר יורד</option>
              <option value="pages_asc">עמודים עולה</option>
              <option value="pages_desc">עמודים יורד</option>
              <option value="title_asc">שם (A→Z)</option>
              <option value="title_desc">שם (Z→A)</option>
            </select>
          </div>
        </div>

        <div id="booksStatus" class="status hint">
          לחצי על <b>רשימת ספרים</b> כדי לטעון את הנתונים מה־DB.
        </div>

        <div id="booksTableWrap" class="tableWrap" style="display:none;"></div>
      </section>

      <!-- PARTICIPANTS -->
      <aside class="card" aria-label="Participants Section">
        <div class="card__head">
          <h2 class="card__title">משתתפות</h2>
        </div>

        <div class="actions">
          <button class="btn" id="btnLoadParticipants">הצג משתתפים</button>
        </div>

        <div id="participantsStatus" class="status hint">
          לחצי על <b>הצג משתתפים</b> כדי להציג את הרשימה.
        </div>

        <ul id="participantsList" class="list" style="display:none;"></ul>
      </aside>

    </div>

    <footer class="footer">Library Database Project — Shira & Hodaya ©</footer>
  </main>

  <script>
    const API_BASE = "https://final-project-1-4tg9.onrender.com"; // Render URL

    async function fetchJson(path) {
      const url = API_BASE + path;
      const res = await fetch(url);

      const contentType = res.headers.get("content-type") || "";
      const text = await res.text();

      if (!res.ok) throw new Error(text || ("HTTP " + res.status));
      if (!contentType.includes("application/json")) {
        throw new Error("השרת לא החזיר JSON. כנראה API_BASE לא נכון או שהשרת לא רץ.");
      }
      return JSON.parse(text);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // ---------- BOOKS ----------
    const btnLoadBooks = document.getElementById("btnLoadBooks");
    const booksStatus = document.getElementById("booksStatus");
    const booksTableWrap = document.getElementById("booksTableWrap");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const booksCounter = document.getElementById("booksCounter");

    let allBooks = [];
    let booksOpen = false;
    let booksLoadedOnce = false;

    function renderBooksTable(rows) {
      if (!rows || rows.length === 0) {
        booksTableWrap.innerHTML = "";
        booksCounter.style.display = "none";
        booksStatus.innerHTML = "<span class='error'>לא נמצאו ספרים.</span>";
        return;
      }

      booksTableWrap.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>product_id</th>
              <th>title</th>
              <th>number_of_pages</th>
              <th>author_id</th>
              <th>price</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td>${escapeHtml(r.product_id)}</td>
                <td class="cell-title">${escapeHtml(r.title)}</td>
                <td>${escapeHtml(r.number_of_pages)}</td>
                <td>${escapeHtml(r.author_id)}</td>
                <td>${escapeHtml(r.price)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      booksCounter.style.display = "inline-flex";
      booksCounter.textContent = `מוצגים ${rows.length} ספרים`;
      booksStatus.innerHTML = `<span class="ok">נטענו ${rows.length} ספרים בהצלחה.</span>`;
    }

    function applySearchAndSort() {
      let rows = [...allBooks];

      const q = (searchInput.value || "").trim().toLowerCase();
      if (q) {
        rows = rows.filter(b => {
          const title = String(b.title ?? "").toLowerCase();
          const id = String(b.product_id ?? "").toLowerCase();
          return title.includes(q) || id.includes(q);
        });
      }

      const v = sortSelect.value;
      const getNum = (x) => Number(x ?? 0);

      rows.sort((a, b) => {
        switch (v) {
          case "product_id_asc": return getNum(a.product_id) - getNum(b.product_id);
          case "product_id_desc": return getNum(b.product_id) - getNum(a.product_id);
          case "price_asc": return getNum(a.price) - getNum(b.price);
          case "price_desc": return getNum(b.price) - getNum(a.price);
          case "pages_asc": return getNum(a.number_of_pages) - getNum(b.number_of_pages);
          case "pages_desc": return getNum(b.number_of_pages) - getNum(a.number_of_pages);
          case "title_asc": return String(a.title ?? "").localeCompare(String(b.title ?? ""));
          case "title_desc": return String(b.title ?? "").localeCompare(String(a.title ?? ""));
          default: return 0;
        }
      });

      renderBooksTable(rows);
    }

    function closeBooksUI() {
      booksOpen = false;
      btnLoadBooks.textContent = "רשימת ספרים";
      booksTableWrap.style.display = "none";
      booksTableWrap.innerHTML = "";
      booksCounter.style.display = "none";
      searchInput.value = "";
      searchInput.disabled = true;
      sortSelect.disabled = true;
      booksStatus.innerHTML = `לחצי על <b>רשימת ספרים</b> כדי לטעון את הנתונים מה־DB.`;
    }

    btnLoadBooks.addEventListener("click", async () => {
      // toggle close
      if (booksOpen) {
        closeBooksUI();
        return;
      }

      // open
      booksOpen = true;
      btnLoadBooks.textContent = "סגור ספרים";
      booksTableWrap.style.display = "block";

      // show cached
      if (booksLoadedOnce && allBooks.length) {
        searchInput.disabled = false;
        sortSelect.disabled = false;
        applySearchAndSort();
        return;
      }

      booksStatus.textContent = "טוען ספרים מה־DB...";
      booksTableWrap.innerHTML = "";
      booksCounter.style.display = "none";

      try {
        allBooks = await fetchJson("/api/books");
        booksLoadedOnce = true;

        searchInput.disabled = false;
        sortSelect.disabled = false;
        applySearchAndSort();
      } catch (e) {
        closeBooksUI();
        booksStatus.innerHTML = `<span class="error">שגיאה בטעינת ספרים: ${escapeHtml(e.message)}</span>`;
      }
    });

    searchInput.addEventListener("input", () => {
      if (booksOpen) applySearchAndSort();
    });
    sortSelect.addEventListener("change", () => {
      if (booksOpen) applySearchAndSort();
    });

    // ---------- PARTICIPANTS ----------
    const btnLoadParticipants = document.getElementById("btnLoadParticipants");
    const participantsStatus = document.getElementById("participantsStatus");
    const participantsList = document.getElementById("participantsList");

    let participantsOpen = false;
    let participantsLoadedOnce = false;
    let cachedParticipants = [];

    function closeParticipantsUI() {
      participantsOpen = false;
      btnLoadParticipants.textContent = "הצג משתתפים";
      participantsList.style.display = "none";
      participantsList.innerHTML = "";
      participantsStatus.innerHTML = `לחצי על <b>הצג משתתפים</b> כדי להציג את הרשימה.`;
    }

    btnLoadParticipants.addEventListener("click", async () => {
      // toggle close
      if (participantsOpen) {
        closeParticipantsUI();
        return;
      }

      // open
      participantsOpen = true;
      btnLoadParticipants.textContent = "סגור משתתפים";

      // show cached
      if (participantsLoadedOnce && cachedParticipants.length) {
        participantsList.style.display = "block";
        participantsStatus.innerHTML = `<span class="ok">המשתתפות הוצגו בהצלחה.</span>`;
        return;
      }

      participantsStatus.textContent = "טוען משתתפות...";
      participantsList.style.display = "none";
      participantsList.innerHTML = "";

      try {
        const parts = await fetchJson("/api/participants");
        cachedParticipants = parts || [];
        participantsLoadedOnce = true;

        participantsList.innerHTML = cachedParticipants.map(p => {
          const name =
            (typeof p === "string") ? p :
            (p.name ?? p.full_name ?? p.fullName ?? "");
          return `<li>${escapeHtml(name)}</li>`;
        }).join("");

        participantsList.style.display = "block";
        participantsStatus.innerHTML = `<span class="ok">המשתתפות הוצגו בהצלחה.</span>`;
      } catch (e) {
        closeParticipantsUI();
        participantsStatus.innerHTML = `<span class="error">שגיאה בטעינת משתתפות: ${escapeHtml(e.message)}</span>`;
      }
    });
  </script>
</body>
</html>
