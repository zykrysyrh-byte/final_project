<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>פרויקט מסדי נתונים – ספרייה</title>

  <!-- קישור לעיצוב -->
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="hero">
    <div class="hero__inner">
      <h1>פרויקט מסדי נתונים – ספרייה</h1>
      <p class="subtitle">
        דף אינטרנט המציג “רשימת ספרים” מתוך קובץ נתונים (books.json) עם אפשרות חיפוש ומיון.
      </p>

      <div class="chips">
        <span class="chip">שמות: שירה, הודיה</span>
        <span class="chip">DB: final_project</span>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="panel">
      <div class="panel__head">
        <h2>חיפוש ומיון</h2>
        <p class="muted">הנתונים נטענים מהקובץ <b>books.json</b> שנמצא באותה תיקייה.</p>
      </div>

      <div class="controls">
        <label class="field">
          <span class="field__label">חיפוש לפי כותר / מזהה</span>
          <input id="q" class="input" type="search" placeholder="לדוגמה: 1001 או Databases" />
        </label>

        <label class="field">
          <span class="field__label">מיון</span>
          <select id="sort" class="select">
            <option value="id_asc">מזהה עולה</option>
            <option value="id_desc">מזהה יורד</option>
            <option value="title_asc">כותר עולה</option>
            <option value="title_desc">כותר יורד</option>
            <option value="pages_desc">עמודים – יורד</option>
            <option value="price_desc">מחיר – יורד</option>
          </select>
        </label>

        <div class="buttons">
          <button id="reload" class="btn btn--primary" type="button">רענון</button>
          <button id="clear" class="btn" type="button">ניקוי</button>
        </div>
      </div>

      <div class="status">
        <span id="statusText" class="muted">טוען נתונים…</span>
      </div>
    </section>

    <section class="panel">
      <div class="panel__head">
        <h2>רשימת ספרים</h2>
        <p class="muted">מוצגים: <b id="count">0</b> ספרים</p>
      </div>

      <div class="tableWrap">
        <table class="table" aria-label="Books">
          <thead>
            <tr>
              <th>product_id</th>
              <th>title</th>
              <th>pages</th>
              <th>author_id</th>
              <th>price</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" class="muted center">טוען…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <footer class="footer">
    © Library Database Project — Shira & Hodaya
  </footer>

  <script>
    const els = {
      q: document.getElementById("q"),
      sort: document.getElementById("sort"),
      reload: document.getElementById("reload"),
      clear: document.getElementById("clear"),
      status: document.getElementById("statusText"),
      tbody: document.getElementById("tbody"),
      count: document.getElementById("count"),
    };

    let allBooks = [];

    function normalizeBooks(data) {
      // תומך גם במערך [ ... ] וגם באובייקט { books: [ ... ] }
      const arr = Array.isArray(data) ? data : (data && Array.isArray(data.books) ? data.books : []);
      return arr.map(b => ({
        product_id: b.product_id ?? b.id ?? null,
        title: b.title ?? b.name ?? "",
        pages: b.pages ?? b.number_of_pages ?? b.numberOfPages ?? null,
        author_id: b.author_id ?? b.authorId ?? "",
        price: b.price ?? null
      })).filter(b => b.product_id !== null);
    }

    function setStatus(msg) {
      els.status.textContent = msg;
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    function compare(a, b, mode) {
      if (mode === "id_asc") return (a.product_id - b.product_id);
      if (mode === "id_desc") return (b.product_id - a.product_id);

      if (mode === "title_asc") return (a.title || "").localeCompare(b.title || "", "he");
      if (mode === "title_desc") return (b.title || "").localeCompare(a.title || "", "he");

      if (mode === "pages_desc") return ((b.pages ?? -1) - (a.pages ?? -1));
      if (mode === "price_desc") return ((b.price ?? -1) - (a.price ?? -1));

      return 0;
    }

    function render(list) {
      els.count.textContent = String(list.length);

      if (!list.length) {
        els.tbody.innerHTML = `<tr><td colspan="5" class="muted center">אין נתונים להצגה.</td></tr>`;
        return;
      }

      els.tbody.innerHTML = list.map(b => `
        <tr>
          <td>${escapeHtml(b.product_id)}</td>
          <td>${escapeHtml(b.title)}</td>
          <td>${escapeHtml(b.pages ?? "")}</td>
          <td>${escapeHtml(b.author_id)}</td>
          <td>${escapeHtml(b.price ?? "")}</td>
        </tr>
      `).join("");
    }

    function applyFilters() {
      const q = (els.q.value || "").trim().toLowerCase();
      const sort = els.sort.value;

      let list = [...allBooks];

      if (q) {
        list = list.filter(b =>
          String(b.product_id).includes(q) ||
          (b.title || "").toLowerCase().includes(q) ||
          (b.author_id || "").toLowerCase().includes(q)
        );
      }

      list.sort((a, b) => compare(a, b, sort));
      render(list);
    }

    async function loadBooks() {
      try {
        setStatus("טוען נתונים מ־books.json…");
        const res = await fetch("books.json", { cache: "no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        allBooks = normalizeBooks(data);

        if (!allBooks.length) {
          setStatus("הקובץ נטען, אבל לא נמצאו רשומות בפורמט מתאים. בדקי את מבנה books.json.");
        } else {
          setStatus("נטען בהצלחה ✅");
        }

        applyFilters();
      } catch (e) {
        setStatus("שגיאה בטעינת books.json. ודאי שהוא באותה תיקייה ושפורמט ה־JSON תקין.");
        els.tbody.innerHTML = `<tr><td colspan="5" class="muted center">שגיאה בטעינת נתונים.</td></tr>`;
        els.count.textContent = "0";
      }
    }

    els.reload.addEventListener("click", loadBooks);
    els.clear.addEventListener("click", () => {
      els.q.value = "";
      els.sort.value = "id_asc";
      applyFilters();
      setStatus("נוקה. אפשר לחפש מחדש.");
    });
    els.q.addEventListener("input", applyFilters);
    els.sort.addEventListener("change", applyFilters);

    // טוען אוטומטית כשנכנסים לדף
    loadBooks();
  </script>
</body>
</html>
