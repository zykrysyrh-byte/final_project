<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>פרויקט מסדי נתונים - ספרייה</title>
  <link rel="stylesheet" href="style.css?v=9" />
</head>

<body>
  <div class="bg"></div>

  <header class="hero">
    <div class="hero__inner">
      <h1>פרויקט מסדי נתונים – ספרייה</h1>
      <p class="subtitle">
        נתונים נשאבים מה־MySQL דרך API (Node.js) ומתעדכנים לפי מה שקיים במסד הנתונים.
      </p>

      <div class="meta">
        <span class="pill">MySQL</span>
        <span class="pill">Node.js API</span>
        <span class="pill">GitHub Pages</span>
        <span class="pill">Render</span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">

      <!-- BOOKS -->
      <section class="card" aria-label="Books Section">
        <div class="card__head">
          <h2 class="card__title">Books</h2>
          <div id="booksCounter" class="counter" style="display:none;"></div>
        </div>

        <div class="controls">
          <div class="actions">
            <button class="btn btn--primary" id="btnBooks">
              <span class="btn__text">רשימת ספרים</span>
              <span class="spinner spinner--btn" aria-hidden="true"></span>
            </button>
          </div>

          <div class="field">
            <span>חיפוש</span>
            <input id="searchInput" type="text" placeholder="חיפוש לפי שם ספר / מזהה..." disabled />
          </div>

          <div class="field">
            <span>מיון</span>
            <select id="sortSelect" disabled>
              <option value="product_id_asc">מזהה עולה</option>
              <option value="product_id_desc">מזהה יורד</option>
              <option value="price_asc">מחיר עולה</option>
              <option value="price_desc">מחיר יורד</option>
              <option value="pages_asc">עמודים עולה</option>
              <option value="pages_desc">עמודים יורד</option>
              <option value="title_asc">שם (A→Z)</option>
              <option value="title_desc">שם (Z→A)</option>
            </select>
          </div>
        </div>

        <div id="booksStatus" class="status hint">
          לחצי על <b>רשימת ספרים</b> כדי לטעון את הנתונים מה־DB.
        </div>

        <div id="booksWrap" class="tableWrap" style="display:none;"></div>
      </section>

      <!-- PARTICIPANTS -->
      <aside class="card" aria-label="Participants Section">
        <div class="card__head">
          <h2 class="card__title">משתתפות</h2>
        </div>

        <div class="actions">
          <button class="btn" id="btnParticipants">
            <span class="btn__text">הצג משתתפים</span>
            <span class="spinner spinner--btn" aria-hidden="true"></span>
          </button>
        </div>

        <div id="participantsStatus" class="status hint">
          לחצי על <b>הצג משתתפים</b> כדי להציג את הרשימה.
        </div>

        <ul id="participantsList" class="list" style="display:none;"></ul>
      </aside>

    </div>

    <footer class="footer">Library Database Project — Shira & Hodaya ©</footer>
  </main>

  <script>
    const API_BASE = "https://final-project-1-4tg9.onrender.com";

    // --- helpers ---
    async function fetchJson(path) {
      const res = await fetch(API_BASE + path);
      const ct = res.headers.get("content-type") || "";
      const text = await res.text();
      if (!res.ok) throw new Error(text || ("HTTP " + res.status));
      if (!ct.includes("application/json")) throw new Error("השרת לא החזיר JSON (בדקי API_BASE/שרת).");
      return JSON.parse(text);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setBtnLoading(btn, on, txt) {
      const t = btn.querySelector(".btn__text");
      const s = btn.querySelector(".spinner--btn");
      if (on) {
        btn.disabled = true;
        if (txt) t.textContent = txt;
        s.style.display = "inline-block";
      } else {
        btn.disabled = false;
        s.style.display = "none";
      }
    }

    // hide all spinners at start
    document.querySelectorAll(".spinner--btn").forEach(x => x.style.display = "none");

    // --- DOM ---
    const btnBooks = document.getElementById("btnBooks");
    const booksStatus = document.getElementById("booksStatus");
    const booksWrap = document.getElementById("booksWrap");
    const booksCounter = document.getElementById("booksCounter");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");

    const btnParticipants = document.getElementById("btnParticipants");
    const participantsStatus = document.getElementById("participantsStatus");
    const participantsList = document.getElementById("participantsList");

    // --- state ---
    let booksOpen = false;
    let participantsOpen = false;

    let booksLoaded = false;
    let allBooks = [];

    let participantsLoaded = false;
    let participantsCache = [];

    // --- open/close functions (מסתירים בלבד, לא מוחקים תוכן!) ---
    function closeBooksUI() {
      booksOpen = false;
      booksWrap.style.display = "none";
      booksCounter.style.display = "none";
      searchInput.disabled = true;
      sortSelect.disabled = true;
      btnBooks.querySelector(".btn__text").textContent = "רשימת ספרים";
      booksStatus.innerHTML = `לחצי על <b>רשימת ספרים</b> כדי לטעון את הנתונים מה־DB.`;
    }

    function openBooksUI() {
      booksOpen = true;
      booksWrap.style.display = "block";
      btnBooks.querySelector(".btn__text").textContent = "סגור ספרים";
      searchInput.disabled = !booksLoaded;
      sortSelect.disabled = !booksLoaded;
    }

    function closeParticipantsUI() {
      participantsOpen = false;
      participantsList.style.display = "none";
      btnParticipants.querySelector(".btn__text").textContent = "הצג משתתפים";
      participantsStatus.innerHTML = `לחצי על <b>הצג משתתפים</b> כדי להציג את הרשימה.`;
    }

    function openParticipantsUI() {
      participantsOpen = true;
      participantsList.style.display = "block";
      btnParticipants.querySelector(".btn__text").textContent = "סגור משתתפים";
    }

    // --- render books ---
    function renderBooks(rows) {
      if (!rows || rows.length === 0) {
        booksStatus.innerHTML = "<span class='error'>לא נמצאו ספרים.</span>";
        booksWrap.innerHTML = "";
        booksCounter.style.display = "none";
        return;
      }

      booksWrap.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>product_id</th>
              <th>title</th>
              <th>number_of_pages</th>
              <th>author_id</th>
              <th>price</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td>${escapeHtml(r.product_id)}</td>
                <td class="cell-title">${escapeHtml(r.title)}</td>
                <td>${escapeHtml(r.number_of_pages)}</td>
                <td>${escapeHtml(r.author_id)}</td>
                <td>${escapeHtml(r.price)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
      booksCounter.style.display = "inline-flex";
      booksCounter.textContent = `מוצגים ${rows.length} ספרים`;
      booksStatus.innerHTML = `<span class="ok">נטענו ${rows.length} ספרים בהצלחה.</span>`;
    }

    function applySearchSort() {
      let rows = [...allBooks];
      const q = (searchInput.value || "").trim().toLowerCase();
      if (q) {
        rows = rows.filter(b => {
          const title = String(b.title ?? "").toLowerCase();
          const id = String(b.product_id ?? "").toLowerCase();
          return title.includes(q) || id.includes(q);
        });
      }

      const v = sortSelect.value;
      const num = (x) => Number(x ?? 0);

      rows.sort((a, b) => {
        switch (v) {
          case "product_id_asc": return num(a.product_id) - num(b.product_id);
          case "product_id_desc": return num(b.product_id) - num(a.product_id);
          case "price_asc": return num(a.price) - num(b.price);
          case "price_desc": return num(b.price) - num(a.price);
          case "pages_asc": return num(a.number_of_pages) - num(b.number_of_pages);
          case "pages_desc": return num(b.number_of_pages) - num(a.number_of_pages);
          case "title_asc": return String(a.title ?? "").localeCompare(String(b.title ?? ""));
          case "title_desc": return String(b.title ?? "").localeCompare(String(a.title ?? ""));
          default: return 0;
        }
      });

      renderBooks(rows);
    }

    // --- events ---
    btnBooks.addEventListener("click", async () => {
      // toggle close
      if (booksOpen) {
        closeBooksUI();
        return;
      }

      // ✅ open books and force close participants
      if (participantsOpen) closeParticipantsUI();
      openBooksUI();

      // if already loaded -> render from cache
      if (booksLoaded) {
        applySearchSort();
        return;
      }

      setBtnLoading(btnBooks, true, "טוען ספרים...");
      booksStatus.textContent = "טוען ספרים מה־DB...";
      booksWrap.innerHTML = "";

      try {
        allBooks = await fetchJson("/api/books");
        booksLoaded = true;
        searchInput.disabled = false;
        sortSelect.disabled = false;
        applySearchSort();
      } catch (e) {
        closeBooksUI();
        booksStatus.innerHTML = `<span class="error">שגיאה בטעינת ספרים: ${escapeHtml(e.message)}</span>`;
      } finally {
        setBtnLoading(btnBooks, false);
        if (booksOpen) btnBooks.querySelector(".btn__text").textContent = "סגור ספרים";
      }
    });

    searchInput.addEventListener("input", () => { if (booksOpen) applySearchSort(); });
    sortSelect.addEventListener("change", () => { if (booksOpen) applySearchSort(); });

    btnParticipants.addEventListener("click", async () => {
      // toggle close
      if (participantsOpen) {
        closeParticipantsUI();
        return;
      }

      // ✅ open participants and force close books
      if (booksOpen) closeBooksUI();
      openParticipantsUI();

      // if already loaded -> show from cache (הכי חשוב ללחיצה השנייה!)
      if (participantsLoaded) {
        participantsList.innerHTML = participantsCache.map(n => `<li>${escapeHtml(n)}</li>`).join("");
        participantsStatus.innerHTML = `<span class="ok">המשתתפות הוצגו בהצלחה.</span>`;
        return;
      }

      setBtnLoading(btnParticipants, true, "טוען...");
      participantsStatus.textContent = "טוען משתתפות...";
      participantsList.innerHTML = "";

      try {
        const parts = await fetchJson("/api/participants");
        participantsCache = (parts || []).map(p => {
          const name =
            (typeof p === "string") ? p :
            (p.name ?? p.full_name ?? p.fullName ?? "");
          return name || "";
        }).filter(Boolean);

        participantsLoaded = true;

        participantsList.innerHTML = participantsCache.map(n => `<li>${escapeHtml(n)}</li>`).join("");
        participantsStatus.innerHTML = `<span class="ok">המשתתפות הוצגו בהצלחה.</span>`;
      } catch (e) {
        closeParticipantsUI();
        participantsStatus.innerHTML = `<span class="error">שגיאה בטעינת משתתפות: ${escapeHtml(e.message)}</span>`;
      } finally {
        setBtnLoading(btnParticipants, false);
        if (participantsOpen) btnParticipants.querySelector(".btn__text").textContent = "סגור משתתפים";
      }
    });
  </script>
</body>
</html>
