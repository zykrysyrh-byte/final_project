<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>פרויקט מסדי נתונים – ספרייה</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="hero">
    <div class="hero__inner">
      <h1>פרויקט מסדי נתונים – ספרייה</h1>
      <p class="subtitle">
        דף תצוגה ל־<b>“רשימת ספרים”</b> מתוך <code>books.json</code> (מיוצא מה־SQL).
      </p>

      <div class="meta">
        <span class="pill">מסד נתונים: <b>final_project</b></span>
        <span class="pill">משתתפות: <b>שירה</b>, <b>הודיה</b></span>
      </div>
    </div>
  </header>

  <main class="container">

    <section class="card">
      <h2 class="card__title">חיפוש ומיון</h2>

      <div class="controls">
        <label class="field">
          <span>חיפוש לפי כותר / מזהה:</span>
          <input id="search" type="text" placeholder="לדוגמה: 1001 או Databases" />
        </label>

        <label class="field">
          <span>מיון:</span>
          <select id="sort">
            <option value="id_asc">מזהה ↑</option>
            <option value="id_desc">מזהה ↓</option>
            <option value="title_asc">כותר ↑</option>
            <option value="title_desc">כותר ↓</option>
            <option value="price_asc">מחיר ↑</option>
            <option value="price_desc">מחיר ↓</option>
            <option value="pages_asc">עמודים ↑</option>
            <option value="pages_desc">עמודים ↓</option>
          </select>
        </label>

        <div class="actions">
          <button id="load" class="btn btn--primary">טעינת ספרים</button>
          <button id="clear" class="btn">ניקוי</button>
        </div>
      </div>

      <p class="hint">
        כדי “לסנכרן” עם ה־SQL: מריצים שאילתת SELECT ב-MySQL, מייצאים לתוצאה, ומדביקים/שומרים אותה ב־<code>books.json</code>.
      </p>
    </section>

    <section class="card">
      <div class="card__head">
        <h2 class="card__title">רשימת ספרים</h2>
        <div class="counter" id="counter">מוצגים: 0</div>
      </div>

      <div class="tableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>מזהה</th>
              <th>כותר</th>
              <th>עמודים</th>
              <th>מזהה סופר</th>
              <th>מחיר</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr>
              <td colspan="5" class="empty">לחצי על “טעינת ספרים”.</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div id="status" class="status"></div>
    </section>

  </main>

  <footer class="footer">
    © Library Database Project — Shira & Hodaya
  </footer>

<script>
  const loadBtn = document.getElementById("load");
  const clearBtn = document.getElementById("clear");
  const searchEl = document.getElementById("search");
  const sortEl = document.getElementById("sort");
  const rowsEl = document.getElementById("rows");
  const statusEl = document.getElementById("status");
  const counterEl = document.getElementById("counter");

  let books = [];

  function normBook(x) {
    // תומך בכמה שמות שדות אפשריים כדי שלא תתקעי
    return {
      product_id: Number(x.product_id ?? x.book_id ?? x.id ?? x.productId),
      title: String(x.title ?? x.book_title ?? x.name ?? ""),
      pages: Number(x.pages ?? x.number_of_pages ?? x.num_pages ?? 0),
      author_id: Number(x.author_id ?? x.authorId ?? x.author ?? 0),
      price: Number(x.price ?? x.book_price ?? 0)
    };
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }

  function render(list) {
    counterEl.textContent = `מוצגים: ${list.length}`;

    if (!list.length) {
      rowsEl.innerHTML = `<tr><td colspan="5" class="empty">אין נתונים להצגה.</td></tr>`;
      return;
    }

    rowsEl.innerHTML = list.map(b => `
      <tr>
        <td>${Number.isFinite(b.product_id) ? b.product_id : ""}</td>
        <td>${escapeHtml(b.title)}</td>
        <td>${Number.isFinite(b.pages) ? b.pages : ""}</td>
        <td>${Number.isFinite(b.author_id) ? b.author_id : ""}</td>
        <td>${Number.isFinite(b.price) ? b.price : ""}</td>
      </tr>
    `).join("");
  }

  function applyFilters() {
    const q = searchEl.value.trim().toLowerCase();
    let filtered = [...books];

    if (q) {
      filtered = filtered.filter(b =>
        String(b.product_id).includes(q) ||
        b.title.toLowerCase().includes(q)
      );
    }

    const sort = sortEl.value;
    const cmpNum = (a, b, key, dir) => (a[key] - b[key]) * dir;
    const cmpStr = (a, b, key, dir) => a[key].localeCompare(b[key], "he") * dir;

    switch (sort) {
      case "id_asc":    filtered.sort((a,b)=>cmpNum(a,b,"product_id", 1)); break;
      case "id_desc":   filtered.sort((a,b)=>cmpNum(a,b,"product_id",-1)); break;
      case "title_asc": filtered.sort((a,b)=>cmpStr(a,b,"title", 1)); break;
      case "title_desc":filtered.sort((a,b)=>cmpStr(a,b,"title",-1)); break;
      case "price_asc": filtered.sort((a,b)=>cmpNum(a,b,"price", 1)); break;
      case "price_desc":filtered.sort((a,b)=>cmpNum(a,b,"price",-1)); break;
      case "pages_asc": filtered.sort((a,b)=>cmpNum(a,b,"pages", 1)); break;
      case "pages_desc":filtered.sort((a,b)=>cmpNum(a,b,"pages",-1)); break;
    }

    render(filtered);
  }

  loadBtn.addEventListener("click", async () => {
    statusEl.textContent = "טוען books.json...";
    try {
      // חשוב: אותו תיקייה כמו index.html
      const res = await fetch("./books.json", { cache: "no-store" });
      if (!res.ok) throw new Error("לא הצלחתי להוריד את books.json (בדקי שם/מיקום).");
      const data = await res.json();

      // תומך גם אם זה מערך וגם אם זה {books:[...]}
      const arr = Array.isArray(data) ? data : (data.books ?? []);
      books = arr.map(normBook).filter(b => b.title || Number.isFinite(b.product_id));

      statusEl.textContent = `נטענו ${books.length} ספרים.`;
      applyFilters();
    } catch (e) {
      books = [];
      render([]);
      statusEl.textContent = "שגיאה: " + e.message;
    }
  });

  clearBtn.addEventListener("click", () => {
    books = [];
    searchEl.value = "";
    sortEl.value = "id_asc";
    statusEl.textContent = "";
    counterEl.textContent = "מוצגים: 0";
    rowsEl.innerHTML = `<tr><td colspan="5" class="empty">לחצי על “טעינת ספרים”.</td></tr>`;
  });

  searchEl.addEventListener("input", applyFilters);
  sortEl.addEventListener("change", applyFilters);
</script>
</body>
</html>
