<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>פרויקט מסדי נתונים - ספרייה</title>
  <link rel="stylesheet" href="style.css?v=11" />
</head>

<body>
  <div class="bg"></div>

 <header class="hero">
  <h1>פרויקט מסדי נתונים – ספרייה</h1>

  <p class="subtitle">
    נתונים נשאבים מה־MySQL דרך API (Node.js) ומתעדכנים לפי מה שקיים במסד הנתונים
  </p>
      <div class="meta">
        <span class="pill">MySQL</span>
        <span class="pill">Node.js API</span>
        <span class="pill">GitHub Pages</span>
        <span class="pill">Render</span>
      </div>
    </div>

  <main class="container">
    <div class="grid">

  <div class="meta">
    <span class="pill">Database: <b>final_project</b></span>
    <span class="pill">משתתפות: <b>שירה זכרי, הודיה אסתר זכרי</b></span>
  </div>
</header>


      <!-- BOOKS -->
      <section class="card" aria-label="Books Section">
        <div class="card__head">
          <h2 class="card__title">Books</h2>
          <div id="booksCounter" class="counter" style="display:none;"></div>
        </div>

        <div class="controls">
          <div class="actions">
            <button class="btn btn--primary" id="btnBooks">
              <span class="btn__text">רשימת ספרים</span>
              <span class="spinner spinner--btn" aria-hidden="true"></span>
            </button>

            <!-- ✅ CSV -->
            <button class="btn btn--ghost" id="btnCsv" disabled title="הורדה ל-CSV">
              <span>הורד CSV</span>
            </button>
          </div>

          <div class="field">
            <span>חיפוש</span>
            <div class="inputWrap">
              <input id="searchInput" type="text" placeholder="חיפוש לפי שם / מזהה / סופר / מחיר..." disabled />
              <button id="btnClearSearch" class="clearBtn" type="button" title="ניקוי חיפוש" aria-label="ניקוי חיפוש">✕</button>
            </div>
          </div>

          <div class="field">
            <span>מיון</span>
            <select id="sortSelect" disabled>
              <option value="product_id_asc">מזהה עולה</option>
              <option value="product_id_desc">מזהה יורד</option>
              <option value="price_asc">מחיר עולה</option>
              <option value="price_desc">מחיר יורד</option>
              <option value="pages_asc">עמודים עולה</option>
              <option value="pages_desc">עמודים יורד</option>
              <option value="title_asc">שם (A→Z)</option>
              <option value="title_desc">שם (Z→A)</option>
            </select>
          </div>
        </div>

        <div id="booksStatus" class="status hint">
          לחצי על <b>רשימת ספרים</b> כדי לטעון את הנתונים מה־DB.
        </div>

        <div id="booksWrap" class="tableWrap" style="display:none;"></div>
      </section>

      <!-- PARTICIPANTS -->
      <aside class="card" aria-label="Participants Section">
        <div class="card__head">
          <h2 class="card__title">משתתפות</h2>
        </div>

        <div class="actions">
          <button class="btn" id="btnParticipants">
            <span class="btn__text">הצג משתתפים</span>
            <span class="spinner spinner--btn" aria-hidden="true"></span>
          </button>
        </div>

        <div id="participantsStatus" class="status hint">
          לחצי על <b>הצג משתתפים</b> כדי להציג את הרשימה.
        </div>

        <ul id="participantsList" class="list" style="display:none;"></ul>
      </aside>

    </div>

    <footer class="footer">Library Database Project — Shira & Hodaya ©</footer>
  </main>

  <script>
    const API_BASE = "https://final-project-1-4tg9.onrender.com";

    async function fetchJson(path) {
      const res = await fetch(API_BASE + path);
      const ct = res.headers.get("content-type") || "";
      const text = await res.text();
      if (!res.ok) throw new Error(text || ("HTTP " + res.status));
      if (!ct.includes("application/json")) throw new Error("השרת לא החזיר JSON (בדקי API_BASE/שרת).");
      return JSON.parse(text);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function setBtnLoading(btn, on, txt) {
      const t = btn.querySelector(".btn__text");
      const s = btn.querySelector(".spinner--btn");
      if (on) {
        btn.disabled = true;
        if (txt) t.textContent = txt;
        s.style.display = "inline-block";
      } else {
        btn.disabled = false;
        s.style.display = "none";
      }
    }

    document.querySelectorAll(".spinner--btn").forEach(x => x.style.display = "none");

    // DOM
    const btnBooks = document.getElementById("btnBooks");
    const booksStatus = document.getElementById("booksStatus");
    const booksWrap = document.getElementById("booksWrap");
    const booksCounter = document.getElementById("booksCounter");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const btnClearSearch = document.getElementById("btnClearSearch");

    const btnCsv = document.getElementById("btnCsv");

    const btnParticipants = document.getElementById("btnParticipants");
    const participantsStatus = document.getElementById("participantsStatus");
    const participantsList = document.getElementById("participantsList");

    // state
    let openPanel = null; // "books" | "participants" | null

    let booksLoaded = false;
    let allBooks = [];
    let currentBooksRows = [];

    let participantsLoaded = false;
    let participantsCache = [];

    // ---------- Toggle helpers ----------
    function closeBooksUI() {
      booksWrap.style.display = "none";
      booksCounter.style.display = "none";
      searchInput.disabled = true;
      sortSelect.disabled = true;
      btnCsv.disabled = true;
      btnBooks.querySelector(".btn__text").textContent = "רשימת ספרים";
      booksStatus.innerHTML = `לחצי על <b>רשימת ספרים</b> כדי לטעון את הנתונים מה־DB.`;
      if (openPanel === "books") openPanel = null;
    }

    function openBooksUI() {
      booksWrap.style.display = "block";
      btnBooks.querySelector(".btn__text").textContent = "סגור ספרים";
      if (booksLoaded) {
        searchInput.disabled = false;
        sortSelect.disabled = false;
        btnCsv.disabled = currentBooksRows.length === 0;
      }
      openPanel = "books";
    }

    function closeParticipantsUI() {
      participantsList.style.display = "none";
      btnParticipants.querySelector(".btn__text").textContent = "הצג משתתפים";
      participantsStatus.innerHTML = `לחצי על <b>הצג משתתפים</b> כדי להציג את הרשימה.`;
      if (openPanel === "participants") openPanel = null;
    }

    function openParticipantsUI() {
      participantsList.style.display = "block";
      btnParticipants.querySelector(".btn__text").textContent = "סגור משתתפים";
      openPanel = "participants";
    }

    function forceCloseOther(target) {
      if (target === "books" && openPanel === "participants") closeParticipantsUI();
      if (target === "participants" && openPanel === "books") closeBooksUI();
    }

    // ---------- (2) Highlight in text ----------
    function escapeRegExp(s) {
      return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function highlightText(text, q) {
      const t = String(text ?? "");
      const query = (q || "").trim();
      if (!query) return escapeHtml(t);

      const re = new RegExp("(" + escapeRegExp(query) + ")", "ig");
      // Escape first, then apply highlight safely by splitting on match
      const parts = t.split(re);
      return parts.map((p, i) => {
        const isMatch = i % 2 === 1;
        return isMatch ? `<mark class="hl">${escapeHtml(p)}</mark>` : escapeHtml(p);
      }).join("");
    }

    function formatPrice(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return escapeHtml(v);
      return "₪" + n.toFixed(2);
    }

    // ---------- Books render ----------
    function renderBooks(rows, query) {
      currentBooksRows = rows || [];
      btnCsv.disabled = !(currentBooksRows.length > 0);

      const total = allBooks.length;
      const shown = currentBooksRows.length;

      if (!rows || rows.length === 0) {
        booksStatus.innerHTML = "<span class='error'>לא נמצאו תוצאות.</span>";
        booksWrap.innerHTML = `
          <div class="emptyBox">
            <div class="emptyTitle">לא נמצאו תוצאות</div>
            <div class="emptySub">נסי לשנות חיפוש או לנקות.</div>
          </div>
        `;
        booksCounter.style.display = "inline-flex";
        booksCounter.textContent = `מוצגים ${shown} מתוך ${total}`;
        return;
      }

      booksWrap.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th class="num">מזהה</th>
              <th>שם ספר</th>
              <th class="num">עמודים</th>
              <th class="num">מזהה סופר/ת</th>
              <th class="num">מחיר</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r => `
              <tr>
                <td class="num">${escapeHtml(r.product_id)}</td>
                <td class="cell-title">${highlightText(r.title, query)}</td>
                <td class="num">${escapeHtml(r.number_of_pages)}</td>
                <td class="num">${highlightText(r.author_id, query)}</td>
                <td class="num">${highlightText(formatPrice(r.price), query)}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      booksCounter.style.display = "inline-flex";
      booksCounter.textContent = `מוצגים ${shown} מתוך ${total}`;
      booksStatus.innerHTML = `<span class="ok">טעינה בוצעה בהצלחה.</span>`;
    }

    function applySearchSort() {
      let rows = [...allBooks];

      const q = (searchInput.value || "").trim().toLowerCase();
      if (q) {
        rows = rows.filter(b => {
          const title = String(b.title ?? "").toLowerCase();
          const id = String(b.product_id ?? "").toLowerCase();
          const author = String(b.author_id ?? "").toLowerCase();
          const price = String(b.price ?? "").toLowerCase();
          return title.includes(q) || id.includes(q) || author.includes(q) || price.includes(q);
        });
      }

      const v = sortSelect.value;
      const num = (x) => Number(x ?? 0);

      rows.sort((a, b) => {
        switch (v) {
          case "product_id_asc": return num(a.product_id) - num(b.product_id);
          case "product_id_desc": return num(b.product_id) - num(a.product_id);
          case "price_asc": return num(a.price) - num(b.price);
          case "price_desc": return num(b.price) - num(a.price);
          case "pages_asc": return num(a.number_of_pages) - num(b.number_of_pages);
          case "pages_desc": return num(b.number_of_pages) - num(a.number_of_pages);
          case "title_asc": return String(a.title ?? "").localeCompare(String(b.title ?? ""));
          case "title_desc": return String(b.title ?? "").localeCompare(String(a.title ?? ""));
          default: return 0;
        }
      });

      renderBooks(rows, (searchInput.value || "").trim());
    }

    // ---------- (1) CSV Export ----------
    function toCsvValue(v) {
      const s = String(v ?? "");
      // escape quotes by doubling them
      const escaped = s.replaceAll('"', '""');
      return `"${escaped}"`;
    }

    function downloadCsv(rows) {
      if (!rows || rows.length === 0) return;

      // header labels
      const header = ["product_id", "title", "number_of_pages", "author_id", "price"];
      const lines = [];
      lines.push(header.map(toCsvValue).join(","));

      for (const r of rows) {
        const line = [
          r.product_id,
          r.title,
          r.number_of_pages,
          r.author_id,
          r.price
        ].map(toCsvValue).join(",");
        lines.push(line);
      }

      const blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      const stamp = new Date().toISOString().slice(0,19).replaceAll(":", "-");
      a.download = `books_${stamp}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    btnCsv.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      downloadCsv(currentBooksRows);
    });

    btnClearSearch.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      if (searchInput.disabled) return;
      searchInput.value = "";
      applySearchSort();
      searchInput.focus();
    });

    // ---------- Books button ----------
    btnBooks.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();

      // toggle close
      if (openPanel === "books") {
        closeBooksUI();
        return;
      }

      // close other first
      forceCloseOther("books");
      openBooksUI();

      // cached
      if (booksLoaded) {
        applySearchSort();
        return;
      }

      setBtnLoading(btnBooks, true, "טוען ספרים...");
      booksStatus.textContent = "טוען ספרים מה־DB...";
      booksWrap.innerHTML = "";

      try {
        allBooks = await fetchJson("/api/books");
        booksLoaded = true;

        searchInput.disabled = false;
        sortSelect.disabled = false;

        applySearchSort();
      } catch (err) {
        closeBooksUI();
        booksStatus.innerHTML = `<span class="error">שגיאה בטעינת ספרים: ${escapeHtml(err.message)}</span>`;
      } finally {
        setBtnLoading(btnBooks, false);
        if (openPanel === "books") btnBooks.querySelector(".btn__text").textContent = "סגור ספרים";
      }
    });

    searchInput.addEventListener("input", () => { if (openPanel === "books") applySearchSort(); });
    sortSelect.addEventListener("change", () => { if (openPanel === "books") applySearchSort(); });

    // ---------- Participants ----------
    btnParticipants.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();

      // toggle close
      if (openPanel === "participants") {
        closeParticipantsUI();
        return;
      }

      // close other first
      forceCloseOther("participants");
      openParticipantsUI();

      // cached
      if (participantsLoaded) {
        participantsList.innerHTML = participantsCache.map(n => `<li>${escapeHtml(n)}</li>`).join("");
        participantsStatus.innerHTML = `<span class="ok">המשתתפות הוצגו בהצלחה.</span>`;
        return;
      }

      setBtnLoading(btnParticipants, true, "טוען...");
      participantsStatus.textContent = "טוען משתתפות...";
      participantsList.innerHTML = "";

      try {
        const parts = await fetchJson("/api/participants");

        participantsCache = (parts || []).map(p => {
          const name = (typeof p === "string") ? p : (p.name ?? p.full_name ?? p.fullName ?? "");
          return name || "";
        }).filter(Boolean);

        participantsLoaded = true;

        participantsList.innerHTML = participantsCache.map(n => `<li>${escapeHtml(n)}</li>`).join("");
        participantsStatus.innerHTML = `<span class="ok">המשתתפות הוצגו בהצלחה.</span>`;
      } catch (err) {
        closeParticipantsUI();
        participantsStatus.innerHTML = `<span class="error">שגיאה בטעינת משתתפות: ${escapeHtml(err.message)}</span>`;
      } finally {
        setBtnLoading(btnParticipants, false);
        if (openPanel === "participants") btnParticipants.querySelector(".btn__text").textContent = "סגור משתתפים";
      }
    });
  </script>
</body>
</html>



